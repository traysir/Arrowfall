<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="description" content="Arrowfall - A rhythm game that analyzes your music and generates beatmaps">
  <meta name="theme-color" content="#0f0f0f">
  <title>Arrowfall</title>
  
  <!-- Google AdSense -->
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-XXXXXXXXXXXXXXXX"
       crossorigin="anonymous"></script>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <style>
    :root {
      --glow-color: rgba(236, 72, 153, 0.4);
      --surface-1: #0a0a0a;
      --surface-2: #141414;
      --surface-3: #1a1a1a;
      --surface-4: #222222;
      --text-primary: #ffffff;
      --text-secondary: rgba(255, 255, 255, 0.7);
      --text-muted: rgba(255, 255, 255, 0.4);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      overflow-x: hidden;
      touch-action: manipulation;
      background: var(--surface-1);
      color: var(--text-primary);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* Respect user's motion preferences */
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }
    
    /* GPU acceleration for animations */
    .gpu-accelerated {
      will-change: transform;
      transform: translateZ(0);
      backface-visibility: hidden;
    }
    
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.03); }
    }
    
    @keyframes slideIn {
      from { transform: translateY(-12px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    
    @keyframes particleFade {
      0% { transform: translate(0, 0) scale(1); opacity: 1; }
      100% { transform: translate(var(--tx), var(--ty)) scale(0); opacity: 0; }
    }
    
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-4px); }
      75% { transform: translateX(4px); }
    }
    
    @keyframes hitBurst {
      0% { transform: scale(1); opacity: 1; }
      100% { transform: scale(2); opacity: 0; }
    }
    
    @keyframes comboGlow {
      0% { text-shadow: 0 0 8px currentColor; }
      50% { text-shadow: 0 0 20px currentColor; }
      100% { text-shadow: 0 0 8px currentColor; }
    }
    
    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-12px); }
    }
    
    @keyframes perfectRing {
      0% { transform: scale(0.5); opacity: 1; }
      100% { transform: scale(1.8); opacity: 0; }
    }
    
    @keyframes starBurst {
      0% { transform: scale(0) rotate(0deg); opacity: 1; }
      100% { transform: scale(1.3) rotate(180deg); opacity: 0; }
    }
    
    @keyframes fadeOut {
      to { opacity: 0; }
    }
    
    @keyframes comboBounce {
      0% { transform: scale(0.9); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }

    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(16px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes subtlePulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    @keyframes borderGlow {
      0%, 100% { border-color: var(--glow-color); }
      50% { border-color: var(--glow-color-bright, var(--glow-color)); }
    }
    
    .animate-pulse-slow { animation: pulse 2.5s ease-in-out infinite; }
    .animate-slide-in { animation: slideIn 0.25s ease-out; }
    .animate-shake { animation: shake 0.25s ease-in-out; }
    .animate-float { animation: float 4s ease-in-out infinite; }
    .particle { animation: particleFade 0.5s ease-out forwards; }
    .hit-burst { animation: hitBurst 0.4s ease-out forwards; }
    .perfect-ring { animation: perfectRing 0.5s ease-out forwards; }
    .star-burst { animation: starBurst 0.6s ease-out forwards; }
    .combo-bounce { animation: comboBounce 0.25s ease-out, comboGlow 0.4s ease-in-out; }
    
    .hit-flash {
      position: absolute;
      inset: 0;
      background: radial-gradient(circle, rgba(255, 255, 255, 0.6) 0%, transparent 60%);
      pointer-events: none;
      animation: fadeOut 0.25s ease-out forwards;
    }
    
    .progress-bar { transition: width 0.1s linear; }
    
    .genre-card {
      transition: all 0.2s ease;
      position: relative;
      overflow: hidden;
    }
    
    .genre-card:hover { 
      transform: translateY(-6px) scale(1.02); 
    }
    
    .genre-card:focus-visible {
      outline: 2px solid white;
      outline-offset: 2px;
    }
    
    .lane-glow { box-shadow: 0 0 24px currentColor; }
    
    .bg-pattern {
      position: absolute;
      inset: 0;
      opacity: 0.015;
      background-size: 24px 24px;
      background-image: linear-gradient(to right, rgba(255,255,255,0.1) 1px, transparent 1px),
                        linear-gradient(to bottom, rgba(255,255,255,0.1) 1px, transparent 1px);
      pointer-events: none;
    }
    
    .card {
      background: var(--surface-2);
      border: 1px solid rgba(255, 255, 255, 0.06);
      border-radius: 16px;
    }

    .card-elevated {
      background: var(--surface-3);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 20px;
      box-shadow: 0 4px 24px rgba(0, 0, 0, 0.4);
    }

    .title-main {
      position: relative;
      display: inline-block;
      font-size: 6rem;
      font-weight: 900;
      color: white;
      letter-spacing: -2px;
      text-shadow: 0 0 60px var(--glow-color);
    }

    .title-accent {
      background: linear-gradient(135deg, var(--accent-start, #ec4899), var(--accent-end, #8b5cf6));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .subtitle {
      font-size: 1.25rem;
      color: var(--text-secondary);
      font-weight: 500;
      letter-spacing: 0.5px;
    }

    .divider-line {
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.15), transparent);
      margin: 1.5rem auto;
      width: 100%;
      max-width: 400px;
    }

    .description-text {
      font-size: 1rem;
      color: var(--text-secondary);
      animation: fadeInUp 0.6s ease-out 0.2s both;
    }

    /* Touch control zones for mobile */
    .touch-zone {
      position: absolute;
      bottom: 0;
      height: 50%;
      display: flex;
      align-items: flex-end;
      justify-content: center;
      padding-bottom: 1.5rem;
      -webkit-tap-highlight-color: transparent;
      user-select: none;
    }

    .touch-zone:active .touch-btn {
      transform: scale(1.15);
      background: var(--active-color);
    }

    .touch-btn {
      width: 64px;
      height: 64px;
      border-radius: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.75rem;
      font-weight: 700;
      background: rgba(255, 255, 255, 0.08);
      border: 2px solid rgba(255, 255, 255, 0.2);
      transition: transform 0.1s, background 0.1s;
    }

    .btn {
      font-weight: 600;
      border: none;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .btn:hover {
      transform: translateY(-1px);
    }

    .btn:active {
      transform: translateY(0);
    }

    .btn-primary {
      background: var(--accent-color, #ec4899);
      color: white;
      box-shadow: 0 2px 12px rgba(236, 72, 153, 0.3);
    }

    .btn-primary:hover {
      box-shadow: 0 4px 20px rgba(236, 72, 153, 0.4);
    }

    .btn-secondary {
      background: var(--surface-3);
      color: var(--text-primary);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .btn-secondary:hover {
      background: var(--surface-4);
      border-color: rgba(255, 255, 255, 0.15);
    }

    .stat-label {
      font-size: 0.75rem;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-muted);
    }

    .stat-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text-primary);
    }

    /* Scrollbar styling */
    ::-webkit-scrollbar {
      width: 8px;
    }
    
    ::-webkit-scrollbar-track {
      background: var(--surface-1);
    }
    
    ::-webkit-scrollbar-thumb {
      background: var(--surface-4);
      border-radius: 4px;
    }

    @media (max-width: 768px) {
      .title-main { font-size: 3.5rem; letter-spacing: -1px; }
      .subtitle { font-size: 1rem; }
    }

    @media (max-width: 480px) {
      .title-main { font-size: 2.75rem; }
    }

    /* Monetization Styles */
    .support-btn {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      font-weight: 600;
      font-size: 0.875rem;
      transition: all 0.2s ease;
      text-decoration: none;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .support-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }
    
    .kofi-btn {
      background: linear-gradient(135deg, #FF5E5B 0%, #FF1744 100%);
      color: white;
    }
    
    .patreon-btn {
      background: linear-gradient(135deg, #FF424D 0%, #FF424D 100%);
      color: white;
    }
    
    .buymeacoffee-btn {
      background: linear-gradient(135deg, #FFDD00 0%, #FFA500 100%);
      color: #000;
    }
    
    .ad-container {
      margin: 1rem auto;
      text-align: center;
      min-height: 90px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(255, 255, 255, 0.02);
      border: 1px solid rgba(255, 255, 255, 0.05);
      border-radius: 8px;
    }
    
    .support-footer {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(10, 10, 10, 0.95);
      backdrop-filter: blur(10px);
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      padding: 0.75rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 1rem;
      z-index: 50;
      flex-wrap: wrap;
    }
    
    @media (max-width: 768px) {
      .support-footer {
        padding: 0.5rem;
        gap: 0.5rem;
      }
      .support-btn {
        font-size: 0.75rem;
        padding: 0.4rem 0.8rem;
      }
    }
  </style>
</head>
<body>
  <div id="app"></div>

  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel">
    const { useState, useRef, useEffect, useCallback, useMemo } = React;

    // ============================================
    // CONFIGURATION
    // ============================================
    const GENRE_THEMES = {
      pop: {
        name: 'Pop', emoji: 'üíñ', description: 'Bright & Catchy',
        bg: 'from-neutral-950 via-neutral-900 to-neutral-950',
        primary: '#ec4899',
        secondary: '#d946ef',
        accent: 'pink-500', 
        glow: 'rgba(236, 72, 153, 0.35)',
        noteGradient: 'from-pink-500 to-pink-400',
        hitZone: 'from-pink-500/20 to-transparent',
        textColor: '#ec4899',
        borderColor: 'border-pink-500/40',
        trailColor: 'rgba(236, 72, 153, 0.15)'
      },
      rock: {
        name: 'Rock', emoji: 'üé∏', description: 'Classic & Powerful',
        bg: 'from-neutral-950 via-neutral-900 to-neutral-950',
        primary: '#f97316',
        secondary: '#ef4444',
        accent: 'orange-500', 
        glow: 'rgba(249, 115, 22, 0.35)',
        noteGradient: 'from-orange-500 to-orange-400',
        hitZone: 'from-orange-500/20 to-transparent',
        textColor: '#f97316',
        borderColor: 'border-orange-500/40',
        trailColor: 'rgba(249, 115, 22, 0.15)'
      },
      heavy: {
        name: 'Heavy', emoji: 'üíÄ', description: 'Brutal & Intense',
        bg: 'from-neutral-950 via-neutral-900 to-neutral-950',
        primary: '#dc2626',
        secondary: '#991b1b',
        accent: 'red-600', 
        glow: 'rgba(220, 38, 38, 0.35)',
        noteGradient: 'from-red-600 to-red-500',
        hitZone: 'from-red-600/20 to-transparent',
        textColor: '#dc2626',
        borderColor: 'border-red-600/40',
        trailColor: 'rgba(220, 38, 38, 0.15)'
      },
      electronic: {
        name: 'Electronic', emoji: '‚ö°', description: 'Energetic & Vibrant',
        bg: 'from-neutral-950 via-neutral-900 to-neutral-950',
        primary: '#06b6d4',
        secondary: '#3b82f6',
        accent: 'cyan-400', 
        glow: 'rgba(6, 182, 212, 0.35)',
        noteGradient: 'from-cyan-400 to-cyan-300',
        hitZone: 'from-cyan-500/20 to-transparent',
        textColor: '#06b6d4',
        borderColor: 'border-cyan-400/40',
        trailColor: 'rgba(6, 182, 212, 0.15)'
      }
    };

    const LANES = ['left', 'down', 'up', 'right'];
    const LANE_KEYS = { ArrowLeft: 'left', ArrowDown: 'down', ArrowUp: 'up', ArrowRight: 'right' };
    const LANE_ICONS = { left: '‚Üê', down: '‚Üì', up: '‚Üë', right: '‚Üí' };
    
    const GAME_CONFIG = {
      HIT_WINDOW: 0.2,
      NOTE_SPEED: 2,
      AUDIO_OFFSET: 0.0,
      HIT_ZONE_POSITION: 85,
      TIMING: {
        perfect: 0.07,
        good: 0.13
      },
      POINTS: {
        perfect: 100,
        good: 75,
        ok: 50
      },
      DIFFICULTY: {
        easy: { notesPerBeat: 1, skipPattern: 2 },
        medium: { notesPerBeat: 1, skipPattern: 0 },
        hard: { notesPerBeat: 2, skipPattern: 0 }
      }
    };

    // ============================================
    // AUDIO ANALYSIS MODULE
    // ============================================
    const AudioAnalyzer = {
      async analyze(file) {
        const arrayBuffer = await file.arrayBuffer();
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
        
        const channelData = audioBuffer.getChannelData(0);
        const sampleRate = audioBuffer.sampleRate;
        const duration = audioBuffer.duration;
        
        const { beats, beatEnergies } = this.detectBeats(channelData, sampleRate);
        const bpm = this.estimateBPM(beats);
        
        audioContext.close();
        
        return { duration, bpm, beats, beatEnergies, beatCount: beats.length };
      },

      detectBeats(channelData, sampleRate) {
        const beats = [];
        const beatEnergies = [];
        const windowSize = Math.floor(sampleRate * 0.043);
        const hopSize = Math.floor(windowSize / 8);
        
        // Calculate energy envelope
        const energies = [];
        for (let i = 0; i < channelData.length - windowSize; i += hopSize) {
          let energy = 0;
          for (let j = 0; j < windowSize; j++) {
            const sample = channelData[i + j];
            energy += sample * sample;
          }
          energies.push({ 
            time: i / sampleRate, 
            energy: Math.sqrt(energy / windowSize)
          });
        }
        
        // Find max energy for normalization
        const maxEnergy = Math.max(...energies.map(e => e.energy));
        
        // Smoothing
        const smoothed = [];
        const smoothWindow = 5;
        for (let i = smoothWindow; i < energies.length - smoothWindow; i++) {
          let sum = 0;
          for (let j = -smoothWindow; j <= smoothWindow; j++) {
            sum += energies[i + j].energy;
          }
          smoothed.push({
            time: energies[i].time,
            energy: sum / (smoothWindow * 2 + 1),
            rawEnergy: energies[i].energy
          });
        }
        
        // Derivative (change in energy)
        const derivatives = [];
        for (let i = 1; i < smoothed.length; i++) {
          derivatives.push({
            time: smoothed[i].time,
            derivative: smoothed[i].energy - smoothed[i - 1].energy,
            energy: smoothed[i].rawEnergy
          });
        }
        
        // Find peaks
        const sorted = [...derivatives].sort((a, b) => b.derivative - a.derivative);
        let threshold = sorted[Math.floor(sorted.length * 0.15)]?.derivative || 0;
        
        let lastBeat = -1;
        const minInterval = 0.15;
        
        for (let i = 10; i < derivatives.length - 10; i++) {
          const current = derivatives[i];
          
          if (current.derivative > threshold && current.derivative > 0) {
            let isLocalMax = true;
            for (let j = -5; j <= 5; j++) {
              if (j !== 0 && derivatives[i + j]?.derivative > current.derivative) {
                isLocalMax = false;
                break;
              }
            }
            
            if (isLocalMax && (current.time - lastBeat) >= minInterval) {
              beats.push(current.time);
              beatEnergies.push(current.energy / maxEnergy); // Normalized 0-1
              lastBeat = current.time;
            }
          }
        }
        
        // Retry with lower threshold if needed
        if (beats.length < 50) {
          const lowerThreshold = sorted[Math.floor(sorted.length * 0.25)]?.derivative || 0;
          beats.length = 0;
          beatEnergies.length = 0;
          lastBeat = -1;
          
          for (let i = 10; i < derivatives.length - 10; i++) {
            const current = derivatives[i];
            
            if (current.derivative > lowerThreshold && current.derivative > 0) {
              let isLocalMax = true;
              for (let j = -3; j <= 3; j++) {
                if (j !== 0 && derivatives[i + j]?.derivative > current.derivative) {
                  isLocalMax = false;
                  break;
                }
              }
              
              if (isLocalMax && (current.time - lastBeat) >= minInterval) {
                beats.push(current.time);
                beatEnergies.push(current.energy / maxEnergy); // Normalized 0-1
                lastBeat = current.time;
              }
            }
          }
        }
        
        return { beats, beatEnergies };
      },

      estimateBPM(beats) {
        if (beats.length < 2) return 120;
        
        const intervals = [];
        for (let i = 1; i < Math.min(beats.length, 50); i++) {
          intervals.push(beats[i] - beats[i - 1]);
        }
        
        intervals.sort((a, b) => a - b);
        const medianInterval = intervals[Math.floor(intervals.length / 2)];
        return Math.round(60 / medianInterval);
      }
    };

    // ============================================
    // NOTE GENERATOR MODULE  
    // ============================================
    const NoteGenerator = {
      generate(beats, beatEnergies, difficulty) {
        const notes = [];
        const settings = GAME_CONFIG.DIFFICULTY[difficulty];
        
        // Calculate energy threshold for multi-notes (top 15% of energies = climax)
        const sortedEnergies = [...beatEnergies].sort((a, b) => b - a);
        const climaxThreshold = sortedEnergies[Math.floor(sortedEnergies.length * 0.10)] || 0.8;
        const highEnergyThreshold = sortedEnergies[Math.floor(sortedEnergies.length * 0.25)] || 0.6;
        
        beats.forEach((beatTime, index) => {
          if (settings.skipPattern > 0 && index % settings.skipPattern !== 0) return;
          
          const energy = beatEnergies[index] || 0;
          let notesToGenerate = settings.notesPerBeat;
          
          // Determine multi-note based on energy levels
          if (difficulty === 'hard') {
            if (energy >= climaxThreshold) {
              notesToGenerate = 4; // All 4 lanes for climax moments
            } else if (energy >= highEnergyThreshold) {
              notesToGenerate = 3; // 3 lanes for high energy
            } else {
              notesToGenerate = Math.min(2, settings.notesPerBeat);
            }
          } else if (difficulty === 'medium') {
            if (energy >= climaxThreshold) {
              notesToGenerate = 3; // 3 lanes for climax
            } else if (energy >= highEnergyThreshold) {
              notesToGenerate = 2; // 2 lanes for high energy
            }
          } else { // easy
            if (energy >= climaxThreshold) {
              notesToGenerate = 2; // 2 lanes for climax on easy
            }
          }
          
          const usedLanes = new Set();
          
          for (let i = 0; i < notesToGenerate; i++) {
            let lane;
            let attempts = 0;
            
            do {
              lane = LANES[Math.floor(Math.random() * LANES.length)];
              attempts++;
            } while (usedLanes.has(lane) && attempts < 10);
            
            usedLanes.add(lane);
            
            // Multi-notes at same time don't need offset
            const offset = notesToGenerate > 1 ? 0 : (i * 0.15);
            
            notes.push({
              id: `${beatTime}-${lane}-${i}`,
              lane,
              time: beatTime + offset,
              hit: false,
              missed: false,
              isMultiNote: notesToGenerate > 1
            });
          }
        });
        
        return notes.sort((a, b) => a.time - b.time);
      }
    };

    // ============================================
    // GAME TIMING ENGINE (using requestAnimationFrame)
    // ============================================
    const useGameLoop = (isPlaying, onTick) => {
      const frameRef = useRef(null);
      const lastTimeRef = useRef(0);
      const startTimeRef = useRef(0);
      
      useEffect(() => {
        if (!isPlaying) {
          if (frameRef.current) {
            cancelAnimationFrame(frameRef.current);
          }
          return;
        }
        
        startTimeRef.current = performance.now();
        lastTimeRef.current = startTimeRef.current;
        
        const tick = (currentTime) => {
          const deltaTime = (currentTime - lastTimeRef.current) / 1000;
          const elapsedTime = (currentTime - startTimeRef.current) / 1000;
          
          lastTimeRef.current = currentTime;
          onTick(elapsedTime, deltaTime);
          
          frameRef.current = requestAnimationFrame(tick);
        };
        
        frameRef.current = requestAnimationFrame(tick);
        
        return () => {
          if (frameRef.current) {
            cancelAnimationFrame(frameRef.current);
          }
        };
      }, [isPlaying, onTick]);
      
      return startTimeRef;
    };

    // ============================================
    // VISUAL EFFECTS COMPONENT
    // ============================================
    const VisualEffects = ({ particles, hitBursts, perfectRings, starBursts, theme }) => (
      <>
        {particles.map(p => (
          <div
            key={p.id}
            className="absolute particle gpu-accelerated"
            style={{
              left: `${(p.laneIndex + 0.5) * 25}%`,
              top: '85%',
              width: `${p.size}px`,
              height: `${p.size}px`,
              borderRadius: '50%',
              backgroundColor: p.color,
              boxShadow: `0 0 6px ${p.color}`,
              '--tx': `${p.x}px`,
              '--ty': `${p.y}px`
            }}
          />
        ))}
        
        {hitBursts.map(b => (
          <div
            key={b.id}
            className="absolute w-20 h-20 rounded-full border-2 hit-burst gpu-accelerated"
            style={{
              left: `${(b.laneIndex + 0.5) * 25}%`,
              top: '85%',
              transform: 'translate(-50%, -50%)',
              borderColor: theme.primary,
              boxShadow: `0 0 20px ${theme.glow}`
            }}
          />
        ))}
        
        {perfectRings.map(r => (
          <div
            key={r.id}
            className="absolute w-20 h-20 rounded-full border-2 border-yellow-400 perfect-ring gpu-accelerated"
            style={{
              left: `${(r.laneIndex + 0.5) * 25}%`,
              top: '85%',
              transform: 'translate(-50%, -50%)',
              boxShadow: '0 0 20px rgba(251, 191, 36, 0.6)'
            }}
          />
        ))}
        
        {starBursts.map(s => (
          <div
            key={s.id}
            className="absolute star-burst gpu-accelerated"
            style={{
              left: `${(s.laneIndex + 0.5) * 25}%`,
              top: '85%',
              width: '48px',
              height: '48px',
              background: 'linear-gradient(45deg, #fbbf24, #f59e0b)',
              clipPath: 'polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%)',
              transform: `translate(-50%, -50%) rotate(${s.rotation}deg)`,
              filter: 'drop-shadow(0 0 8px #fbbf24)'
            }}
          />
        ))}
      </>
    );

    // ============================================
    // TOUCH CONTROLS COMPONENT
    // ============================================
    const TouchControls = ({ onLanePress, theme }) => {
      const handleTouch = useCallback((lane, e) => {
        e.preventDefault();
        onLanePress(lane);
      }, [onLanePress]);

      return (
        <div className="absolute inset-0 z-20 md:hidden">
          {LANES.map((lane, index) => (
            <div
              key={lane}
              className="touch-zone"
              style={{ 
                left: `${index * 25}%`, 
                width: '25%',
                '--active-color': theme.primary
              }}
              onTouchStart={(e) => handleTouch(lane, e)}
            >
              <div className="touch-btn">
                {LANE_ICONS[lane]}
              </div>
            </div>
          ))}
        </div>
      );
    };

    // ============================================
    // GENRE SELECTION SCREEN
    // ============================================
    const GenreSelection = ({ onSelect, theme }) => (
      <div className="min-h-screen bg-neutral-950 text-white flex items-center justify-center p-6 relative overflow-hidden">
        <div className="absolute inset-0 bg-pattern"></div>
        
        {/* Subtle ambient glow */}
        <div className="absolute top-1/4 left-1/4 w-[500px] h-[500px] rounded-full opacity-20 blur-3xl"
          style={{background: 'radial-gradient(circle, rgba(236, 72, 153, 0.3) 0%, transparent 70%)'}}></div>
        <div className="absolute bottom-1/4 right-1/4 w-[500px] h-[500px] rounded-full opacity-20 blur-3xl"
          style={{background: 'radial-gradient(circle, rgba(139, 92, 246, 0.3) 0%, transparent 70%)'}}></div>
        
        <div className="max-w-4xl w-full animate-slide-in relative z-10">
          <div className="text-center mb-12">
            <div className="mb-6">
              <h1 className="title-main mb-2">Arrowfall</h1>
              <p className="subtitle">Rhythm Game</p>
            </div>
            
            <div className="divider-line"></div>
            
            <div className="space-y-2 mb-8">
              <p className="description-text">Choose a genre that matches your music</p>
              <p className="text-sm text-neutral-500">Supports MP3, WAV, OGG, FLAC</p>
              <p className="text-sm text-neutral-600">
                Need music? <a href="https://mp3juice.as/" target="_blank" rel="noopener noreferrer" className="hover:underline" style={{color: '#A30F39'}}>Download from MP3 Juice</a>
              </p>
            </div>
          </div>

          <div className="grid grid-cols-2 lg:grid-cols-4 gap-4">
            {Object.entries(GENRE_THEMES).map(([key, genre]) => (
              <button
                key={key}
                onClick={() => onSelect(key)}
                className="genre-card card-elevated p-6 cursor-pointer text-left group"
                style={{'--glow-color': genre.glow}}
              >
                <div className="text-5xl mb-4 group-hover:scale-110 transition-transform duration-200">{genre.emoji}</div>
                <h3 className="text-xl font-bold mb-1" style={{color: genre.primary}}>{genre.name}</h3>
                <p className="text-sm text-neutral-400">{genre.description}</p>
                
                {/* Hover accent line */}
                <div className="absolute bottom-0 left-0 right-0 h-1 rounded-b-xl opacity-0 group-hover:opacity-100 transition-opacity"
                  style={{background: genre.primary}}></div>
              </button>
            ))}
          </div>
          
          <p className="text-center text-neutral-600 text-sm mt-8">
            Automatically analyzes your music to generate beatmaps
          </p>
          
          {/* Support Section */}
          <div className="mt-12 p-6 card-elevated text-center">
            <h3 className="text-lg font-semibold mb-3" style={{color: theme.primary}}>üíñ Support This Free Game</h3>
            <p className="text-sm text-neutral-400 mb-4">Help keep Arrowfall free and ad-supported!</p>
            <div className="flex flex-wrap gap-3 justify-center">
              <a href="https://ko-fi.com/YOURNAME" target="_blank" rel="noopener noreferrer" className="support-btn kofi-btn">
                <span>‚òï</span> Ko-fi
              </a>
              <a href="https://www.patreon.com/YOURNAME" target="_blank" rel="noopener noreferrer" className="support-btn patreon-btn">
                <span>üéÆ</span> Patreon
              </a>
              <a href="https://www.buymeacoffee.com/YOURNAME" target="_blank" rel="noopener noreferrer" className="support-btn buymeacoffee-btn">
                <span>‚òï</span> Buy Me a Coffee
              </a>
            </div>
            <p className="text-xs text-neutral-500 mt-3">Your support helps cover hosting and development costs</p>
          </div>
          
          {/* Ad Space - Top Banner */}
          <div className="ad-container mt-8">
            {/* Replace this div with your actual AdSense code */}
            <ins className="adsbygoogle"
                 style={{display: 'block'}}
                 data-ad-client="ca-pub-XXXXXXXXXXXXXXXX"
                 data-ad-slot="XXXXXXXXXX"
                 data-ad-format="auto"
                 data-full-width-responsive="true"></ins>
          </div>
        </div>
      </div>
    );

    // ============================================
    // SUPPORT FOOTER COMPONENT
    // ============================================
    const SupportFooter = ({ theme }) => (
      <div className="support-footer">
        <span className="text-xs text-neutral-400">Enjoying Arrowfall?</span>
        <a href="https://ko-fi.com/YOURNAME" target="_blank" rel="noopener noreferrer" className="support-btn kofi-btn">
          ‚òï Support
        </a>
        <span className="text-xs text-neutral-500">|</span>
        <a href="#" className="text-xs text-neutral-400 hover:text-white transition-colors">Remove Ads ($2.99)</a>
      </div>
    );

    // ============================================
    // MAIN GAME COMPONENT
    // ============================================
    const RhythmGame = () => {
      // State
      const [selectedGenre, setSelectedGenre] = useState(null);
      const [isAnalyzing, setIsAnalyzing] = useState(false);
      const [isPlaying, setIsPlaying] = useState(false);
      const [songData, setSongData] = useState(null);
      const [notes, setNotes] = useState([]);
      const [score, setScore] = useState(0);
      const [combo, setCombo] = useState(0);
      const [maxCombo, setMaxCombo] = useState(0);
      const [currentTime, setCurrentTime] = useState(0);
      const [hitFeedback, setHitFeedback] = useState({});  // { lane: { accuracy, time } }
      const [particles, setParticles] = useState([]);
      const [hitBursts, setHitBursts] = useState([]);
      const [perfectRings, setPerfectRings] = useState([]);
      const [starBursts, setStarBursts] = useState([]);
      const [stats, setStats] = useState({ perfect: 0, good: 0, ok: 0, miss: 0 });
      const [difficulty, setDifficulty] = useState('medium');
      
      // Refs
      const audioRef = useRef(null);
      const audioStartTimeRef = useRef(0);
      const effectTimeoutsRef = useRef([]);
      
      const theme = useMemo(() => 
        selectedGenre ? GENRE_THEMES[selectedGenre] : GENRE_THEMES.pop,
        [selectedGenre]
      );

      // Cleanup effect timeouts
      const clearEffectTimeouts = useCallback(() => {
        effectTimeoutsRef.current.forEach(clearTimeout);
        effectTimeoutsRef.current = [];
      }, []);

      // Create visual effects with proper cleanup
      const createParticles = useCallback((lane, accuracy) => {
        const laneIndex = LANES.indexOf(lane);
        const particleCount = accuracy === 'perfect' ? 8 : accuracy === 'good' ? 5 : 3;
        const newParticles = [];
        
        for (let i = 0; i < particleCount; i++) {
          const angle = (Math.PI * 2 * i) / particleCount;
          const velocity = 50 + Math.random() * 30;
          
          newParticles.push({
            id: `${Date.now()}-${i}-${Math.random()}`,
            laneIndex,
            x: Math.cos(angle) * velocity,
            y: Math.sin(angle) * velocity,
            color: accuracy === 'perfect' ? '#fbbf24' : accuracy === 'good' ? '#34d399' : '#60a5fa',
            size: accuracy === 'perfect' ? 10 : 6
          });
        }
        
        setParticles(prev => [...prev, ...newParticles]);
        
        const timeout = setTimeout(() => {
          setParticles(prev => prev.filter(p => !newParticles.some(np => np.id === p.id)));
        }, 600);
        effectTimeoutsRef.current.push(timeout);
      }, []);

      const createHitBurst = useCallback((lane) => {
        const laneIndex = LANES.indexOf(lane);
        const burstId = `burst-${Date.now()}-${Math.random()}`;
        
        setHitBursts(prev => [...prev, { id: burstId, laneIndex }]);
        
        const timeout = setTimeout(() => {
          setHitBursts(prev => prev.filter(b => b.id !== burstId));
        }, 500);
        effectTimeoutsRef.current.push(timeout);
      }, []);

      const createPerfectRing = useCallback((lane) => {
        const laneIndex = LANES.indexOf(lane);
        const ringId = `ring-${Date.now()}-${Math.random()}`;
        
        setPerfectRings(prev => [...prev, { id: ringId, laneIndex }]);
        
        const timeout = setTimeout(() => {
          setPerfectRings(prev => prev.filter(r => r.id !== ringId));
        }, 600);
        effectTimeoutsRef.current.push(timeout);
      }, []);

      const createStarBurst = useCallback((lane) => {
        const laneIndex = LANES.indexOf(lane);
        const stars = [];
        
        for (let i = 0; i < 4; i++) {
          stars.push({
            id: `star-${Date.now()}-${i}-${Math.random()}`,
            laneIndex,
            rotation: i * 90
          });
        }
        
        setStarBursts(prev => [...prev, ...stars]);
        
        const timeout = setTimeout(() => {
          setStarBursts(prev => prev.filter(s => !stars.some(star => star.id === s.id)));
        }, 800);
        effectTimeoutsRef.current.push(timeout);
      }, []);

      // Handle file upload
      const handleFileUpload = async (e) => {
        const file = e.target.files[0];
        if (!file || !file.type.startsWith('audio/')) {
          alert('Please upload a valid audio file (MP3, WAV, etc.)');
          return;
        }
        
        setIsAnalyzing(true);
        setScore(0);
        setCombo(0);
        setMaxCombo(0);
        setCurrentTime(0);
        setStats({ perfect: 0, good: 0, ok: 0, miss: 0 });
        
        try {
          const analysis = await AudioAnalyzer.analyze(file);
          const generatedNotes = NoteGenerator.generate(analysis.beats, analysis.beatEnergies, difficulty);
          
          setSongData({
            duration: analysis.duration,
            bpm: analysis.bpm,
            title: file.name.replace(/\.[^/.]+$/, ""),
            beatCount: analysis.beatCount
          });
          
          setNotes(generatedNotes);
          
          // Create audio element
          const audio = new Audio();
          audio.src = URL.createObjectURL(file);
          audio.preload = 'auto';
          audio.volume = 1.0;
          audioRef.current = audio;
          
        } catch (error) {
          console.error('Analysis error:', error);
          alert('Failed to analyze audio. Please try another file.');
        } finally {
          setIsAnalyzing(false);
        }
      };

      // Game loop callback
      const onGameTick = useCallback((elapsedTime) => {
        if (!songData) return;
        
        setCurrentTime(elapsedTime);
        
        // Check for missed notes
        setNotes(prev => prev.map(note => {
          if (!note.hit && !note.missed && (elapsedTime - note.time) > GAME_CONFIG.HIT_WINDOW) {
            setStats(s => ({ ...s, miss: s.miss + 1 }));
            setCombo(0);
            return { ...note, missed: true };
          }
          return note;
        }));
        
        // End game when song finishes
        if (elapsedTime >= songData.duration) {
          stopGame();
        }
      }, [songData]);

      // Use the game loop
      useGameLoop(isPlaying, onGameTick);

      // Start game
      const startGame = useCallback(() => {
        if (!audioRef.current || !songData) return;
        
        setIsPlaying(true);
        setScore(0);
        setCombo(0);
        setMaxCombo(0);
        setCurrentTime(0);
        setStats({ perfect: 0, good: 0, ok: 0, miss: 0 });
        clearEffectTimeouts();
        setParticles([]);
        setHitBursts([]);
        setPerfectRings([]);
        setStarBursts([]);
        
        setNotes(prev => prev.map(note => ({ ...note, hit: false, missed: false })));
        
        audioRef.current.currentTime = 0;
        audioRef.current.play()
          .then(() => {
            audioStartTimeRef.current = performance.now();
          })
          .catch(error => console.error('Audio error:', error));
      }, [songData, clearEffectTimeouts]);

      // Stop game
      const stopGame = useCallback(() => {
        setIsPlaying(false);
        if (audioRef.current) {
          audioRef.current.pause();
        }
        clearEffectTimeouts();
      }, [clearEffectTimeouts]);

      // Handle lane press (keyboard or touch)
      const handleLanePress = useCallback((lane) => {
        if (!isPlaying) return;
        
        const currentGameTime = currentTime + GAME_CONFIG.AUDIO_OFFSET;
        
        const hittableNotes = notes.filter(note => 
          note.lane === lane &&
          !note.hit &&
          !note.missed &&
          Math.abs(note.time - currentGameTime) < GAME_CONFIG.HIT_WINDOW
        );
        
        if (hittableNotes.length > 0) {
          const closestNote = hittableNotes.reduce((closest, note) => 
            Math.abs(note.time - currentGameTime) < Math.abs(closest.time - currentGameTime) ? note : closest
          );
          
          const timeDiff = Math.abs(closestNote.time - currentGameTime);
          const accuracy = timeDiff < GAME_CONFIG.TIMING.perfect ? 'perfect' 
            : timeDiff < GAME_CONFIG.TIMING.good ? 'good' : 'ok';
          
          setNotes(prev => prev.map(n => 
            n.id === closestNote.id ? { ...n, hit: true } : n
          ));
          
          const points = GAME_CONFIG.POINTS[accuracy];
          setScore(prev => prev + points * (1 + combo * 0.1));
          setCombo(prev => {
            const newCombo = prev + 1;
            setMaxCombo(current => Math.max(current, newCombo));
            return newCombo;
          });
          
          setStats(prev => ({ ...prev, [accuracy]: prev[accuracy] + 1 }));
          // Update feedback for this specific lane (allows multiple lanes to light up)
          setHitFeedback(prev => ({ ...prev, [lane]: { accuracy, time: Date.now() } }));
          createParticles(lane, accuracy);
          createHitBurst(lane);
          
          if (accuracy === 'perfect') {
            createPerfectRing(lane);
            if ((combo + 1) % 10 === 0) {
              createStarBurst(lane);
            }
          }
          
          // Clear this lane's feedback after delay
          const timeout = setTimeout(() => {
            setHitFeedback(prev => {
              const updated = { ...prev };
              delete updated[lane];
              return updated;
            });
          }, 200);
          effectTimeoutsRef.current.push(timeout);
          
        } else {
          setCombo(0);
          setHitFeedback(prev => ({ ...prev, [lane]: { accuracy: 'miss', time: Date.now() } }));
          const timeout = setTimeout(() => {
            setHitFeedback(prev => {
              const updated = { ...prev };
              delete updated[lane];
              return updated;
            });
          }, 200);
          effectTimeoutsRef.current.push(timeout);
        }
      }, [isPlaying, currentTime, notes, combo, createParticles, createHitBurst, createPerfectRing, createStarBurst]);

      // Keyboard handler - track pressed keys to allow multiple simultaneous presses
      useEffect(() => {
        const pressedKeys = new Set();
        
        const handleKeyDown = (e) => {
          if (!LANE_KEYS[e.key]) return;
          e.preventDefault();
          // Prevent key repeat from triggering multiple times
          if (pressedKeys.has(e.key)) return;
          pressedKeys.add(e.key);
          handleLanePress(LANE_KEYS[e.key]);
        };
        
        const handleKeyUp = (e) => {
          if (!LANE_KEYS[e.key]) return;
          pressedKeys.delete(e.key);
        };
        
        window.addEventListener('keydown', handleKeyDown);
        window.addEventListener('keyup', handleKeyUp);
        return () => {
          window.removeEventListener('keydown', handleKeyDown);
          window.removeEventListener('keyup', handleKeyUp);
        };
      }, [handleLanePress]);

      // Cleanup on unmount
      useEffect(() => {
        return () => {
          clearEffectTimeouts();
          if (audioRef.current) {
            audioRef.current.pause();
            audioRef.current.src = '';
          }
        };
      }, [clearEffectTimeouts]);

      // Helper functions
      const getNotePosition = (noteTime) => {
        const timeUntilHit = noteTime - currentTime;
        const position = GAME_CONFIG.HIT_ZONE_POSITION - (timeUntilHit / GAME_CONFIG.NOTE_SPEED * GAME_CONFIG.HIT_ZONE_POSITION);
        return Math.max(0, Math.min(100, position));
      };

      const progress = songData ? (currentTime / songData.duration) * 100 : 0;
      const totalHits = stats.perfect + stats.good + stats.ok + stats.miss;
      const accuracy = totalHits > 0
        ? ((stats.perfect + stats.good) / totalHits * 100).toFixed(1)
        : '100.0';

      // Genre selection screen
      if (!selectedGenre) {
        return <GenreSelection onSelect={setSelectedGenre} theme={theme} />;
      }

      // Main game screen
      return (
        <div className="min-h-screen bg-neutral-950 text-white relative overflow-hidden">
          <div className="absolute inset-0 bg-pattern"></div>
          
          {/* Subtle theme-colored ambient glow */}
          <div className="absolute top-0 right-0 w-[600px] h-[600px] rounded-full opacity-10 blur-3xl"
            style={{background: `radial-gradient(circle, ${theme.primary} 0%, transparent 70%)`}}></div>
          
          <div className="container mx-auto px-4 py-6 relative z-10">
            
            {/* Header */}
            <div className="flex items-center justify-between mb-6 animate-slide-in">
              <button
                onClick={() => {
                  if (isPlaying) stopGame();
                  setSelectedGenre(null);
                  setSongData(null);
                }}
                className="btn btn-secondary px-4 py-2 rounded-lg text-sm flex items-center gap-2"
              >
                <span>‚Üê</span>
                <span className="hidden sm:inline">Back</span>
              </button>
              
              <div className="flex items-center gap-3">
                <span className="text-3xl">{theme.emoji}</span>
                <div>
                  <h1 className="text-2xl font-bold">Arrowfall</h1>
                  <p className="text-xs text-neutral-500">{theme.name} Mode</p>
                </div>
              </div>
              
              <div className="w-20"></div> {/* Spacer for centering */}
            </div>

            {/* Upload Section */}
            {!songData && (
              <div className="max-w-xl mx-auto animate-slide-in">
                {/* Difficulty Selection */}
                <div className="mb-6">
                  <p className="text-sm text-neutral-500 mb-3 text-center">Difficulty</p>
                  <div className="flex gap-2 justify-center">
                    {['easy', 'medium', 'hard'].map(diff => (
                      <button
                        key={diff}
                        onClick={() => setDifficulty(diff)}
                        className={`btn px-5 py-2 rounded-lg text-sm font-semibold transition-all ${
                          difficulty === diff
                            ? 'text-white shadow-lg'
                            : 'btn-secondary'
                        }`}
                        style={difficulty === diff ? {background: theme.primary} : {}}
                      >
                        {diff.charAt(0).toUpperCase() + diff.slice(1)}
                      </button>
                    ))}
                  </div>
                </div>

                {/* Upload Area */}
                <label className="block card-elevated p-8 cursor-pointer hover:border-neutral-600 transition-all text-center"
                  style={{borderColor: isAnalyzing ? theme.primary : undefined}}>
                  {isAnalyzing ? (
                    <div className="py-8">
                      <div className="text-5xl mb-4">{theme.emoji}</div>
                      <p className="text-lg font-semibold mb-2">Analyzing audio...</p>
                      <p className="text-sm text-neutral-500 mb-4">Detecting beats & generating patterns</p>
                      <div className="w-48 mx-auto h-1 bg-neutral-800 rounded-full overflow-hidden">
                        <div className="h-full rounded-full animate-pulse" 
                          style={{width: '60%', background: theme.primary}}></div>
                      </div>
                    </div>
                  ) : (
                    <div className="py-8">
                      <div className="w-16 h-16 mx-auto mb-4 rounded-2xl flex items-center justify-center text-3xl"
                        style={{background: `${theme.primary}20`}}>
                        üéµ
                      </div>
                      <p className="text-lg font-semibold mb-1">Drop your track here</p>
                      <p className="text-sm text-neutral-500 mb-3">or click to browse</p>
                      <p className="text-xs text-neutral-600">MP3, WAV, OGG, FLAC supported</p>
                    </div>
                  )}
                  <input 
                    type="file" 
                    className="hidden" 
                    accept="audio/*"
                    onChange={handleFileUpload}
                    disabled={isAnalyzing}
                  />
                </label>
                
                <p className="text-center text-neutral-600 text-xs mt-4">
                  AI analyzes your music to create synchronized beatmaps
                </p>
                
                {/* Ad Space - Below Upload */}
                <div className="ad-container mt-6">
                  <ins className="adsbygoogle"
                       style={{display: 'block'}}
                       data-ad-client="ca-pub-XXXXXXXXXXXXXXXX"
                       data-ad-slot="XXXXXXXXXX"
                       data-ad-format="auto"
                       data-full-width-responsive="true"></ins>
                </div>
              </div>
            )}

            {/* Game Section */}
            {songData && (
              <div className="max-w-5xl mx-auto animate-slide-in">
                
                {/* Song Info & Controls */}
                <div className="card p-4 mb-4">
                  <div className="flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-4">
                    <div className="flex-1 min-w-0">
                      <h2 className="text-lg font-bold truncate mb-1">{songData.title}</h2>
                      <div className="flex flex-wrap gap-x-4 gap-y-1 text-xs text-neutral-500">
                        <span>{songData.bpm} BPM</span>
                        <span>{notes.length} Notes</span>
                        <span className="capitalize">{difficulty}</span>
                      </div>
                    </div>
                    
                    {/* Score Display */}
                    <div className="flex items-center gap-6">
                      <div className="text-right">
                        <div className="stat-label">Score</div>
                        <div className="stat-value" style={{color: theme.primary}}>{Math.round(score).toLocaleString()}</div>
                      </div>
                      <div className="text-right">
                        <div className="stat-label">Combo</div>
                        <div className={`stat-value ${combo > 0 ? 'combo-bounce' : 'text-neutral-600'}`}
                          style={combo > 0 ? {color: '#fbbf24'} : {}}>
                          {combo}x
                        </div>
                      </div>
                      <div className="text-right">
                        <div className="stat-label">Accuracy</div>
                        <div className="stat-value">{accuracy}%</div>
                      </div>
                    </div>
                  </div>
                  
                  {/* Progress bar */}
                  <div className="h-1 bg-neutral-800 rounded-full overflow-hidden mb-4">
                    <div className="h-full progress-bar rounded-full" 
                      style={{width: `${progress}%`, background: theme.primary}}></div>
                  </div>
                  
                  {/* Stats Row */}
                  <div className="flex items-center justify-between">
                    <div className="flex gap-4 text-xs font-medium">
                      <span className="text-yellow-400">‚òÖ {stats.perfect}</span>
                      <span className="text-green-400">‚úì {stats.good}</span>
                      <span className="text-blue-400">‚óÜ {stats.ok}</span>
                      <span className="text-red-400">‚úó {stats.miss}</span>
                      <span className="text-neutral-500">Best: {maxCombo}x</span>
                    </div>
                    
                    {/* Controls */}
                    <div className="flex gap-2">
                      {!isPlaying ? (
                        <button
                          onClick={startGame}
                          className="btn px-6 py-2 rounded-lg font-semibold text-white"
                          style={{background: theme.primary}}
                        >
                          ‚ñ∂ Play
                        </button>
                      ) : (
                        <button
                          onClick={stopGame}
                          className="btn px-6 py-2 rounded-lg font-semibold bg-red-600 text-white"
                        >
                          ‚èπ Stop
                        </button>
                      )}
                      
                      <button
                        onClick={() => {
                          stopGame();
                          setSongData(null);
                          setNotes([]);
                        }}
                        className="btn btn-secondary px-4 py-2 rounded-lg"
                        title="New Song"
                      >
                        ‚Üª
                      </button>
                    </div>
                  </div>
                </div>

                {/* Game Area */}
                <div className="relative bg-neutral-900 rounded-2xl overflow-hidden border border-neutral-800" style={{height: '580px'}}>
                  
                  {/* Subtle vignette */}
                  <div className="absolute inset-0 bg-gradient-to-b from-transparent via-transparent to-black/30 pointer-events-none z-10"></div>
                  
                  {/* Lane container */}
                  <div className="relative h-full flex">
                    {LANES.map((lane, laneIndex) => (
                      <div
                        key={lane}
                        className="relative flex-1 border-x border-neutral-800/50"
                        style={{background: `linear-gradient(to bottom, transparent 0%, ${theme.trailColor} 80%, transparent 100%)`}}
                      >
                        {/* Hit zone indicator */}
                        <div 
                          className={`absolute left-0 right-0 h-28 bg-gradient-to-b ${theme.hitZone}`}
                          style={{ top: '72%' }}
                        />
                        
                        {/* Lane button */}
                        <div className="absolute bottom-6 left-0 right-0 flex justify-center z-10">
                          <div className={`w-20 h-20 rounded-xl flex items-center justify-center text-4xl font-bold transition-all duration-75 ${
                            hitFeedback[lane] && Date.now() - hitFeedback[lane].time < 200
                              ? hitFeedback[lane].accuracy === 'miss' 
                                ? 'bg-red-500 scale-110 animate-shake'
                                : hitFeedback[lane].accuracy === 'perfect'
                                ? 'bg-yellow-400 scale-125 lane-glow text-neutral-900'
                                : hitFeedback[lane].accuracy === 'good'
                                ? 'bg-green-500 scale-120 lane-glow'
                                : 'bg-blue-500 scale-115 lane-glow'
                              : 'bg-neutral-800 border-2 border-neutral-700'
                          }`}>
                            {LANE_ICONS[lane]}
                          </div>
                        </div>
                        
                        {/* Hit flash effect */}
                        {hitFeedback[lane] && hitFeedback[lane].accuracy !== 'miss' && Date.now() - hitFeedback[lane].time < 200 && (
                          <div className="hit-flash" />
                        )}

                        {/* Notes */}
                        {notes
                          .filter(note => note.lane === lane && !note.hit && !note.missed)
                          .map(note => {
                            const position = getNotePosition(note.time);
                            if (position < -5 || position > 105) return null;
                            
                            const isApproaching = position > 70;
                            
                            return (
                              <div
                                key={note.id}
                                className="absolute left-1/2 transform -translate-x-1/2 gpu-accelerated"
                                style={{ top: `${position}%` }}
                              >
                                <div className={`w-14 h-14 bg-gradient-to-br ${theme.noteGradient} rounded-xl flex items-center justify-center text-3xl font-bold border-2 transition-all duration-75 ${theme.borderColor}`}
                                  style={{
                                    boxShadow: isApproaching 
                                      ? `0 0 16px ${theme.glow}` 
                                      : `0 0 8px ${theme.glow}`,
                                    transform: isApproaching ? 'scale(1.05)' : 'scale(1)'
                                  }}>
                                  {LANE_ICONS[lane]}
                                </div>
                              </div>
                            );
                          })}
                      </div>
                    ))}
                  </div>

                  {/* Visual effects layer */}
                  <div className="absolute inset-0 pointer-events-none">
                    <VisualEffects 
                      particles={particles}
                      hitBursts={hitBursts}
                      perfectRings={perfectRings}
                      starBursts={starBursts}
                      theme={theme}
                    />
                  </div>

                  {/* Touch controls (mobile) */}
                  {isPlaying && (
                    <TouchControls onLanePress={handleLanePress} theme={theme} />
                  )}

                  {/* Accuracy feedback - show most recent hit */}
                  {(() => {
                    const recentHit = Object.values(hitFeedback).find(fb => Date.now() - fb.time < 250);
                    if (!recentHit) return null;
                    return (
                      <div className="absolute top-1/3 left-1/2 transform -translate-x-1/2 -translate-y-1/2 pointer-events-none z-20">
                        <div className={`text-5xl font-black animate-slide-in ${
                          recentHit.accuracy === 'perfect' ? 'text-yellow-400' :
                          recentHit.accuracy === 'good' ? 'text-green-400' :
                          recentHit.accuracy === 'ok' ? 'text-blue-400' :
                          'text-red-400'
                        }`} style={{
                          textShadow: '0 0 24px currentColor'
                        }}>
                          {recentHit.accuracy === 'perfect' ? 'PERFECT' :
                           recentHit.accuracy === 'good' ? 'GOOD' :
                           recentHit.accuracy === 'ok' ? 'OK' :
                           'MISS'}
                        </div>
                      </div>
                    );
                  })()}

                  {/* Combo display */}
                  {combo >= 10 && isPlaying && (
                    <div className="absolute top-8 left-1/2 transform -translate-x-1/2 pointer-events-none z-20">
                      <div className={`text-4xl font-black text-yellow-400 ${combo % 10 === 0 ? 'combo-bounce' : ''}`} 
                        style={{textShadow: '0 0 20px rgba(251, 191, 36, 0.6)'}}>
                        {combo}x
                      </div>
                      {combo >= 50 && (
                        <div className="text-center text-sm font-semibold text-white/80 mt-1">
                          üî• ON FIRE
                        </div>
                      )}
                    </div>
                  )}

                  {/* Instructions overlay */}
                  {!isPlaying && (
                    <div className="absolute inset-0 bg-black/85 flex items-center justify-center backdrop-blur-sm z-30">
                      <div className="text-center animate-slide-in px-4">
                        <p className="text-xl font-bold mb-6" style={{color: theme.primary}}>
                          Use Arrow Keys or Tap
                        </p>
                        <div className="flex gap-3 justify-center mb-6">
                          {LANES.map(lane => (
                            <div key={lane} className="w-14 h-14 bg-neutral-800 rounded-xl flex items-center justify-center text-2xl border border-neutral-700">
                              {LANE_ICONS[lane]}
                            </div>
                          ))}
                        </div>
                        <p className="text-neutral-400 text-sm">
                          Hit notes when they reach the <span style={{color: theme.primary}}>target zone</span>
                        </p>
                      </div>
                    </div>
                  )}
                </div>
              </div>
            )}
          </div>
          
          {/* Support Footer */}
          <SupportFooter theme={theme} />
        </div>
      );
    };

    // Mount the app
    const root = ReactDOM.createRoot(document.getElementById('app'));
    root.render(<RhythmGame />);
    
    // Initialize AdSense ads after mounting
    if (window.adsbygoogle) {
      (adsbygoogle = window.adsbygoogle || []).push({});
    }
  </script>
</body>
</html>
